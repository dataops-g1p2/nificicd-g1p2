---
- name: Configure NiFi CI/CD VM
  hosts: all
  become: yes
  gather_facts: yes
  
  vars:
    nifi_user: "{{ ansible_user }}"
    nifi_home: "/home/{{ nifi_user }}/nificicd-g1p2"
    environment_name: "{{ nifi_environment }}"
    github_repo: "{{ lookup('env', 'GITHUB_REPOSITORY') | default('', true) }}"
    github_pat: "{{ github_pat | default('') }}"
    ansible_python_interpreter: /usr/bin/python3
    target_branch: "{{ 'develop' if environment_name == 'development' else ('staging' if environment_name == 'staging' else 'main') }}"
    valid_environments: ['development', 'staging', 'production']
    vm_public_ip: "PLACEHOLDER"
    nifi_username: "admin"
    nifi_password: "PLACEHOLDER"
    NIFI_SENSITIVE_PROPS_KEY: "PLACEHOLDER"
    nifi_https_port: "8443"
    nifi_registry_port: "18080"

  tasks:
    # ================
    # VALIDATE INPUT
    # ================
    - name: Validate environment configuration
      assert:
        that:
          - nifi_environment is defined
          - nifi_environment != ''
          - nifi_environment in valid_environments
        fail_msg: |
          ERROR: Invalid or missing 'nifi_environment' variable!
          
          Usage: ansible-playbook -i inventory.ini ansible/configure-vm.yml \
            -e "nifi_environment=development" \
            -e "github_repo=your-org/your-repo" \
            -e "github_pat=your-pat"
          
          Valid environments: {{ valid_environments | join(', ') }}
        success_msg: "Configuration valid for environment: {{ environment_name }}"
    
    - name: Display configuration
      debug:
        msg:
          - "============================================"
          - " Configuring VM for: {{ environment_name }} " 
          - "============================================"
          - "Repository: {{ github_repo }}"
          - "Branch: {{ target_branch }}"
          - "PAT: {{ 'Configured' if github_pat != '' else 'NOT SET' }}"
    
    # ================
    # SYSTEM PACKAGES
    # ================
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 0
      retries: 5
      delay: 10
      register: apt_update
      until: apt_update is succeeded
      environment:
        DEBIAN_FRONTEND: noninteractive
    
    - name: Add Ubuntu Universe repository
      command: add-apt-repository -y universe
      register: add_universe
      changed_when: "'already' not in add_universe.stdout"
      ignore_errors: yes
      
    - name: Install essential packages
      apt:
        name:
          - git
          - curl
          - wget
          - vim
          - htop
          - rsync
          - ca-certificates
          - gnupg
          - lsb-release
          - jq
          - python3
          - python3-pip
          - software-properties-common
        state: present
        update_cache: no
      retries: 3
      delay: 5
      environment:
        DEBIAN_FRONTEND: noninteractive

    - name: Install optional packages
      apt:
        name:
          - build-essential
          - net-tools
        state: present
        update_cache: no
      ignore_errors: yes
      environment:
        DEBIAN_FRONTEND: noninteractive

    # =========================
    # GITHUB CLI INSTALLATION
    # =========================
    - name: Check if GitHub CLI is installed
      command: gh --version
      register: gh_check
      failed_when: false
      changed_when: false
      
    - name: Install GitHub CLI
      when: gh_check.rc != 0
      block:
        - name: Create keyrings directory
          file:
            path: /etc/apt/keyrings
            state: directory
            mode: '0755'
            
        - name: Download GitHub CLI GPG key
          get_url:
            url: https://cli.github.com/packages/githubcli-archive-keyring.gpg
            dest: /etc/apt/keyrings/githubcli-archive-keyring.gpg
            mode: '0644'
            
        - name: Add GitHub CLI repository
          apt_repository:
            repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main"
            state: present
            filename: github-cli
            
        - name: Install GitHub CLI package
          apt:
            name: gh
            state: present
            update_cache: yes

    - name: Configure GitHub CLI authentication
      when: github_pat != ''
      become_user: "{{ nifi_user }}"
      block:
        - name: Authenticate gh CLI
          shell: |
            gh auth logout --hostname github.com 2>/dev/null || true
            echo "{{ github_pat }}" | tr -d '[:space:]' | gh auth login --hostname github.com --with-token
            gh config set git_protocol https
          environment:
            GH_TOKEN: "{{ github_pat }}"
          no_log: true
          register: gh_login_result
          failed_when: false
          
        - name: Verify gh CLI authentication
          command: gh auth status
          register: gh_auth_status
          failed_when: false
          changed_when: false
          when: gh_login_result.rc == 0

    # ====================
    # DOCKER INSTALLATION
    # ====================
    - name: Check if Docker is installed
      command: docker --version
      register: docker_check
      failed_when: false
      changed_when: false
      
    - name: Install Docker
      when: docker_check.rc != 0
      block:
        - name: Create keyrings directory
          file:
            path: /etc/apt/keyrings
            state: directory
            mode: '0755'
            
        - name: Download Docker GPG key
          get_url:
            url: https://download.docker.com/linux/ubuntu/gpg
            dest: /etc/apt/keyrings/docker.asc
            mode: '0644'
            
        - name: Add Docker repository
          apt_repository:
            repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
            state: present
            filename: docker
            
        - name: Install Docker packages
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
            state: present
            update_cache: yes
    
    - name: Configure Docker
      block:
        - name: Add user to docker group
          user:
            name: "{{ nifi_user }}"
            groups: docker
            append: yes
          register: user_added_to_docker
            
        - name: Configure Docker daemon
          copy:
            content: |
              {
                "log-driver": "json-file",
                "log-opts": {
                  "max-size": "10m",
                  "max-file": "3"
                },
                "default-ulimits": {
                  "nofile": {
                    "Name": "nofile",
                    "Hard": 65536,
                    "Soft": 65536
                  }
                }
              }
            dest: /etc/docker/daemon.json
            mode: '0644'
          notify: Restart Docker
            
        - name: Enable and start Docker service
          systemd:
            name: docker
            state: started
            enabled: yes

        - name: Notify about Docker group membership
          debug:
            msg:
              - "IMPORTANT: You've been added to the docker group"
              - "Log out and back in for Docker access, OR run: newgrp docker"
          when: user_added_to_docker.changed

    # ==================
    # GIT CONFIGURATION
    # ==================
    - name: Configure Git init.defaultBranch only
      become_user: "{{ nifi_user }}"
      community.general.git_config:
        name: "init.defaultBranch"
        value: "main"
        scope: global

    # ====================
    # DIRECTORY STRUCTURE
    # ====================
    - name: Create directory structure
      file:
        path: "{{ item.path }}"
        state: directory
        owner: "{{ item.owner | default(nifi_user) }}"
        group: "{{ item.group | default(nifi_user) }}"
        mode: "{{ item.mode | default('0755') }}"
      loop:
        - { path: "{{ nifi_home }}" }
        - { path: "{{ nifi_home }}/flows" }
        - { path: "{{ nifi_home }}/registry_data", owner: "1000", group: "1000" }
        - { path: "{{ nifi_home }}/registry_data/nifi_registry_database", owner: "1000", group: "1000" }
        - { path: "{{ nifi_home }}/registry_data/nifi_registry_flow_storage", owner: "1000", group: "1000" }
        - { path: "{{ nifi_home }}/config" }
        - { path: "/home/{{ nifi_user }}/backups/{{ environment_name }}" }
        - { path: "/home/{{ nifi_user }}/logs" }

    # ==========================
    # ENVIRONMENT CONFIGURATION 
    # ==========================
    - name: Create environment configuration file
      copy:
        dest: "/home/{{ nifi_user }}/.nifi_cicd_env"
        owner: "{{ nifi_user }}"
        group: "{{ nifi_user }}"
        mode: '0600'
        content: |
          export GITHUB_REPO="{{ github_repo }}"
          export GITHUB_PAT="{{ github_pat }}"
          export NIFI_ENV="{{ environment_name }}"
          export GH_TOKEN="{{ github_pat }}"
          
          {% raw %}
          nifi_check_config() {
            echo "NiFi CI/CD Configuration Status:"
            echo "  Repository: ${GITHUB_REPO:-'Not set'}"
            [ -n "$GITHUB_PAT" ] && echo "  PAT: Set (${#GITHUB_PAT} characters)" || echo "  PAT: Not set"
            echo "  Environment: ${NIFI_ENV:-'Not set'}"
            echo ""
            
            # Check Git identity
            GIT_NAME=$(git config --global user.name 2>/dev/null)
            GIT_EMAIL=$(git config --global user.email 2>/dev/null)
            
            if [ -n "$GIT_NAME" ] && [ -n "$GIT_EMAIL" ]; then
              echo "  Git Identity: $GIT_NAME <$GIT_EMAIL>"
            else
              echo "  Git Identity: NOT CONFIGURED"
              echo ""
              echo "  WARNING: Configure your identity to get credit for your work!"
              echo "  Run: ~/setup-my-identity.sh"
            fi
            
            if command -v gh &> /dev/null && gh auth status &>/dev/null; then
              echo "  GitHub CLI: Authenticated"
            fi
            
            echo ""
            [ -z "$GITHUB_PAT" ] && echo "WARNING: GITHUB_PAT is not set!" && return 1
            
            if [ -d ~/nificicd-g1p2/.git ]; then
              echo "Git repository initialized"
              cd ~/nificicd-g1p2
              git remote get-url origin &>/dev/null && echo "Git remote configured: $(git remote get-url origin)"
              
              # Check if git hook is installed and executable
              if [ -f .git/hooks/post-commit ] && [ -x .git/hooks/post-commit ]; then
                echo "Git hook: Installed and executable"
              else
                echo "Git hook: Missing or not executable - run: ~/install-git-hook.sh"
              fi
            else
              echo "WARNING: Git repository not initialized"
            fi
            
            # Check for .env file
            if [ -f ~/nificicd-g1p2/.env.$NIFI_ENV ]; then
              echo ".env.$NIFI_ENV file exists"
            else
              echo "WARNING: .env.$NIFI_ENV not found - will be created by provision workflow"
            fi
          }
          
          nifi_trigger_workflow() {
            [ -z "$GITHUB_PAT" ] && echo "ERROR: GITHUB_PAT not set. Run: nifi_check_config" && return 1
            ~/trigger-workflow.sh "$@"
          }
          
          nifi_gh_trigger_workflow() {
            [ -z "$GITHUB_REPO" ] && echo "ERROR: GITHUB_REPO not set. Run: nifi_check_config" && return 1
            
            MESSAGE="${1:-Manual trigger from VM}"
            echo "Triggering workflow for $NIFI_ENV using gh CLI..."
            
            gh workflow run webhook-trigger.yml \
              --repo "$GITHUB_REPO" \
              --ref develop \
              -f source_vm="$NIFI_ENV" \
              -f commit_message="$MESSAGE"
            
            [ $? -eq 0 ] && echo "Workflow triggered! Check: https://github.com/$GITHUB_REPO/actions" || echo "Failed to trigger workflow"
          }
          {% endraw %}

    - name: Source environment in bashrc
      lineinfile:
        path: "/home/{{ nifi_user }}/.bashrc"
        line: "source ~/.nifi_cicd_env 2>/dev/null || true"
        regexp: "^source.*nifi_cicd_env"

    # ===================================
    # CREATE PLACEHOLDER .env FILE
    # ===================================
    - name: Create placeholder Docker Compose .env file
      copy:
        dest: "{{ nifi_home }}/.env.{{ environment_name }}"
        owner: "{{ nifi_user }}"
        group: "{{ nifi_user }}"
        mode: '0600'
        force: no
        content: |
          # Docker Compose Environment File for {{ environment_name }}
          # This file will be updated by the provision workflow with actual values
          
          NIFI_USERNAME={{ nifi_username }}
          NIFI_PASSWORD={{ nifi_password }}
          NIFI_SENSITIVE_PROPS_KEY={{ NIFI_SENSITIVE_PROPS_KEY }}
          VM_PUBLIC_IP={{ vm_public_ip }}
          NIFI_WEB_PROXY_HOST={{ vm_public_ip }}:{{ nifi_https_port }}
          NIFI_HTTPS_PORT={{ nifi_https_port }}
          NIFI_REGISTRY_PORT={{ nifi_registry_port }}
      register: env_file_created

    - name: Display .env file status
      debug:
        msg:
          - "{{ '.env.' + environment_name + ' file ' + ('created with placeholders' if env_file_created.changed else 'already exists') }}"
          - "This file will be updated by the provision workflow with actual values"

    # ===============================
    # AUTOMATED GIT REPOSITORY SETUP
    # ===============================
    - name: Check if Git repository exists
      stat:
        path: "{{ nifi_home }}/.git"
      register: git_dir
      become_user: "{{ nifi_user }}"

    - name: Initialize Git repository with sparse checkout
      when: not git_dir.stat.exists and github_repo != ''
      become_user: "{{ nifi_user }}"
      shell: |
        cd {{ nifi_home }}
        
        # Initialize repository
        git init
        git remote add origin https://github.com/{{ github_repo }}.git || true
        
        # Enable sparse checkout
        git config core.sparseCheckout true
        
        # Define what to checkout based on environment
        cat > .git/info/sparse-checkout <<'EOF'
        # Common files for all environments
        Makefile
        README.md
        .gitignore
        
        # Scripts (needed for all environments)
        scripts/
        
        # Ansible (for configuration)
        ansible/
        
        # Environment-specific compose file
        compose.{{ environment_name }}.yml
        
        # Config directory
        config/
        
        # Flows and registry data
        flows/
        registry_data/
        
        # GitHub workflows (optional, for reference)
        .github/
        EOF
        
        # Fetch and checkout the target branch
        git fetch origin {{ target_branch }} || true
        git checkout -b {{ target_branch }} || true
        git pull origin {{ target_branch }} || true
        git branch --set-upstream-to=origin/{{ target_branch }} {{ target_branch }} || true
        
        echo "Repository initialized with sparse checkout for {{ environment_name }}"
      environment:
        GIT_TERMINAL_PROMPT: '0'
      ignore_errors: yes

    - name: Ensure Git remote is configured
      become_user: "{{ nifi_user }}"
      when: git_dir.stat.exists and github_repo != ''
      block:
        - name: Check git remote configuration
          command: git config --get remote.origin.url
          args:
            chdir: "{{ nifi_home }}"
          register: git_remote_check
          failed_when: false
          changed_when: false
        
        - name: Configure git remote if missing
          command: git remote add origin https://github.com/{{ github_repo }}.git
          args:
            chdir: "{{ nifi_home }}"
          when: git_remote_check.rc != 0
          failed_when: false

    # =========================
    # GIT HOOKS & HELPER SCRIPTS
    # =========================
    - name: Copy post-commit hook script to home directory
      copy:
        src: "{{ playbook_dir }}/../scripts/vm-registry-commit-hook.sh"
        dest: "/home/{{ nifi_user }}/post-commit-hook.sh"
        mode: '0755'
        owner: "{{ nifi_user }}"
        group: "{{ nifi_user }}"

    - name: Install Git hook
      when: github_repo != ''
      become_user: "{{ nifi_user }}"
      block:
        - name: Ensure hooks directory exists
          file:
            path: "{{ nifi_home }}/.git/hooks"
            state: directory
            mode: '0755'
          
        - name: Install post-commit hook directly
          copy:
            src: "/home/{{ nifi_user }}/post-commit-hook.sh"
            dest: "{{ nifi_home }}/.git/hooks/post-commit"
            mode: '0755'
            owner: "{{ nifi_user }}"
            group: "{{ nifi_user }}"
            remote_src: yes
        
        - name: Verify hook is executable
          file:
            path: "{{ nifi_home }}/.git/hooks/post-commit"
            mode: '0755'
            state: file
        
        - name: Test hook can source environment
          shell: |
            cd {{ nifi_home }}
            if .git/hooks/post-commit 2>&1 | grep -q "GITHUB_REPO"; then
              echo "Hook can access environment variables"
            fi
          register: hook_test
          failed_when: false
          changed_when: false

    - name: Create developer identity setup script
      copy:
        dest: "/home/{{ nifi_user }}/setup-my-identity.sh"
        mode: '0755'
        owner: "{{ nifi_user }}"
        group: "{{ nifi_user }}"
        content: |
          #!/bin/bash
          echo "=============================="
          echo "  Configure Your Git Identity "
          echo "=============================="
          echo ""
          echo "This ensures YOUR commits are attributed to YOU,"
          echo "not a generic automation user."
          echo ""
          
          # Check if already configured
          CURRENT_NAME=$(git config --global user.name 2>/dev/null)
          CURRENT_EMAIL=$(git config --global user.email 2>/dev/null)
          
          if [ -n "$CURRENT_NAME" ] && [ -n "$CURRENT_EMAIL" ]; then
            echo "Current identity:"
            echo "  Name: $CURRENT_NAME"
            echo "  Email: $CURRENT_EMAIL"
            echo ""
            read -p "Update this identity? (y/N): " UPDATE
            if [[ ! "$UPDATE" =~ ^[Yy]$ ]]; then
              echo "Keeping current identity"
              exit 0
            fi
          fi
          
          echo "Enter your information:"
          read -p "  Full name: " DEV_NAME
          read -p "  Email (use your GitHub email): " DEV_EMAIL
          
          if [ -z "$DEV_NAME" ] || [ -z "$DEV_EMAIL" ]; then
            echo ""
            echo "ERROR: Name and email are required"
            exit 1
          fi
          
          # Configure Git
          git config --global user.name "$DEV_NAME"
          git config --global user.email "$DEV_EMAIL"
          
          echo ""
          echo "========================================"
          echo "  Git Identity Configured Successfully! "
          ech "========================================="
          echo ""
          echo "  Name: $(git config --global user.name)"
          echo "  Email: $(git config --global user.email)"
          echo ""
          echo "All your commits will now be attributed to YOU!"
          echo ""
          echo "Test it:"
          echo "  cd ~/nificicd-g1p2"
          echo "  echo 'test by $(git config --global user.name)' >> flows/test.txt"
          echo "  git add flows/test.txt"
          echo "  git commit -m 'test: verify my identity'"
          echo "  git log -1 --format='%an <%ae>'"
          echo ""

    - name: Create helper scripts
      copy:
        dest: "/home/{{ nifi_user }}/{{ item.name }}"
        mode: '0755'
        owner: "{{ nifi_user }}"
        group: "{{ nifi_user }}"
        content: "{{ item.content }}"
      loop:
        - name: trigger-workflow.sh
          content: |
            #!/bin/bash
            [ -f ~/.nifi_cicd_env ] && source ~/.nifi_cicd_env
            
            GITHUB_REPO="${GITHUB_REPO:-}"
            GITHUB_TOKEN="${GITHUB_PAT:-}"
            ENVIRONMENT="${NIFI_ENV:-development}"
            
            [ -z "$GITHUB_TOKEN" ] || [ -z "$GITHUB_REPO" ] && echo "Error: Configuration incomplete. Run: nifi_check_config" && exit 1
            
            MESSAGE="${1:-Manual trigger from VM}"
            echo "Triggering workflow for $ENVIRONMENT..."
            
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$GITHUB_REPO/dispatches" \
              -d "{\"event_type\":\"vm-registry-commit\",\"client_payload\":{\"environment\":\"$ENVIRONMENT\",\"commit_message\":\"$MESSAGE\",\"vm_hostname\":\"$(hostname)\"}}")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            [ "$HTTP_CODE" = "204" ] && echo "Workflow triggered! Check: https://github.com/$GITHUB_REPO/actions" || echo "Failed (HTTP $HTTP_CODE)"

        - name: install-git-hook.sh
          content: |
            #!/bin/bash
            NIFI_HOME="{{ nifi_home }}"
            HOOK_DIR="$NIFI_HOME/.git/hooks"
            HOOK_FILE="$HOOK_DIR/post-commit"
            SOURCE_HOOK="$HOME/post-commit-hook.sh"
            
            echo "=================================="
            echo "  Installing Git Post-Commit Hook "
            echo "=================================="
            echo ""
            
            if [ ! -d "$NIFI_HOME/.git" ]; then
              echo "Git repository not initialized at $NIFI_HOME"
              exit 1
            fi
            
            if [ ! -f "$SOURCE_HOOK" ]; then
              echo "Source hook not found: $SOURCE_HOOK"
              if [ -f "$NIFI_HOME/post-commit-hook.sh" ]; then
                cp "$NIFI_HOME/post-commit-hook.sh" "$SOURCE_HOOK"
                chmod +x "$SOURCE_HOOK"
              else
                echo "Cannot find post-commit-hook.sh"
                exit 1
              fi
            fi
            
            mkdir -p "$HOOK_DIR"
            
            if [ -f "$HOOK_FILE" ]; then
              BACKUP="$HOOK_FILE.backup.$(date +%Y%m%d_%H%M%S)"
              cp "$HOOK_FILE" "$BACKUP"
              echo "Backed up existing hook: $BACKUP"
            fi
            
            cp "$SOURCE_HOOK" "$HOOK_FILE"
            chmod +x "$HOOK_FILE"
            
            if [ -f "$HOOK_FILE" ] && [ -x "$HOOK_FILE" ]; then
              echo "Git hook installed and executable!"
              echo "Location: $HOOK_FILE"
            else
              echo "Hook installation failed"
              exit 1
            fi

        - name: test-git-hook.sh
          content: |
            #!/bin/bash
            set -e
            
            NIFI_HOME="{{ nifi_home }}"
            HOOK_FILE="$NIFI_HOME/.git/hooks/post-commit"
            
            echo "============================"
            echo "  Git Hook Diagnostic Test  "
            echo "============================"
            echo ""
            
            if [ ! -f "$HOOK_FILE" ]; then
              echo "Hook not found: $HOOK_FILE"
              echo "Install it with: ~/install-git-hook.sh"
              exit 1
            fi
            
            if [ ! -x "$HOOK_FILE" ]; then
              echo "Hook is not executable: $HOOK_FILE"
              echo "Fix with: chmod +x $HOOK_FILE"
              exit 1
            fi
            
            echo "Hook exists and is executable"
            echo ""
            
            source ~/.nifi_cicd_env 2>/dev/null || true
            
            if [ -z "$GITHUB_PAT" ] || [ -z "$GITHUB_REPO" ]; then
              echo "Missing configuration:"
              [ -z "$GITHUB_REPO" ] && echo "  - GITHUB_REPO"
              [ -z "$GITHUB_PAT" ] && echo "  - GITHUB_PAT"
              echo ""
              echo "Run: nifi_check_config"
              exit 1
            fi
            
            echo "Configuration present"
            echo "  Repository: $GITHUB_REPO"
            echo "  Environment: ${NIFI_ENV:-development}"
            echo ""
            
            echo "Creating test commit..."
            cd "$NIFI_HOME"
            
            TEST_FILE="flows/.hook-test-$(date +%s).txt"
            echo "Hook test at $(date)" > "$TEST_FILE"
            git add "$TEST_FILE"
            
            echo ""
            echo "Committing (hook should trigger):"
            echo "----------------------------------------"
            
            git commit -m "test: automated hook verification" 2>&1 | tee /tmp/hook-test.log
            
            echo "----------------------------------------"
            echo ""
            
            if grep -q "Workflow triggered successfully" /tmp/hook-test.log; then
              echo "SUCCESS! Hook executed and triggered workflow!"
            else
              echo "Hook may not have executed correctly"
            fi
            
            rm -f /tmp/hook-test.log

        - name: verify-setup.sh
          content: |
            #!/bin/bash
            echo "===================================="
            echo "  NiFi CI/CD VM Setup Verification  "
            echo "===================================="
            echo ""
            source ~/.nifi_cicd_env 2>/dev/null
            nifi_check_config
            echo ""
            echo "Environment: {{ environment_name }}"
            echo "Compose file: compose.{{ environment_name }}.yml"
            echo ""
            
            HOOK_FILE="{{ nifi_home }}/.git/hooks/post-commit"
            if [ -f "$HOOK_FILE" ] && [ -x "$HOOK_FILE" ]; then
              echo "Git hook: Installed and executable"
            else
              echo "Git hook: Missing or not executable"
              echo "   Fix: ~/install-git-hook.sh"
            fi
            echo ""
            
            echo "Quick Tests:"
            echo "  1. Configure identity: ~/setup-my-identity.sh"
            echo "  2. Test hook: ~/test-git-hook.sh"
            echo "  3. Manual trigger: nifi_trigger_workflow 'Test message'"

        - name: backup-nifi.sh
          content: |
            #!/bin/bash
            BACKUP_DIR="/home/{{ nifi_user }}/backups/{{ environment_name }}"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_FILE="$BACKUP_DIR/nifi-backup-$TIMESTAMP.tar.gz"
            
            echo "Creating NiFi backup..."
            
            # Create backup
            tar -czf "$BACKUP_FILE" \
              -C "{{ nifi_home }}" flows/ registry_data/ .env.{{ environment_name }} 2>/dev/null
            
            if [ $? -ne 0 ]; then
              echo "ERROR: Backup creation failed"
              exit 1
            fi
            
            # Verify backup integrity
            tar -tzf "$BACKUP_FILE" >/dev/null 2>&1
            
            if [ $? -eq 0 ]; then
              SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
              echo "✓ Backup created and verified: $BACKUP_FILE ($SIZE)"
              echo "$TIMESTAMP: Backup verified ($SIZE)" >> "$BACKUP_DIR/backup.log"
            else
              echo "✗ Backup verification FAILED: $BACKUP_FILE"
              echo "$TIMESTAMP: Backup verification FAILED" >> "$BACKUP_DIR/backup.log"
              rm -f "$BACKUP_FILE"
              exit 1
            fi
            
            # Retention policy: Keep last 7 days daily, then weekly for 30 days
            find "$BACKUP_DIR" -name "nifi-backup-*.tar.gz" -mtime +7 -mtime -30 \
              ! -name "*01.tar.gz" ! -name "*08.tar.gz" ! -name "*15.tar.gz" ! -name "*22.tar.gz" \
              -delete 2>/dev/null
            
            # Delete backups older than 30 days
            find "$BACKUP_DIR" -name "nifi-backup-*.tar.gz" -mtime +30 -delete 2>/dev/null
            
            echo ""
            echo "Backup retention:"
            ls -lht "$BACKUP_DIR"/*.tar.gz 2>/dev/null | head -5

        - name: recover-from-backup.sh
          content: |
            #!/bin/bash
            BACKUP_DIR="/home/{{ nifi_user }}/backups/{{ environment_name }}"
            NIFI_HOME="{{ nifi_home }}"
            
            echo "========================================"
            echo "  NiFi Backup Recovery"
            echo "========================================"
            echo ""
            
            if [ ! -d "$BACKUP_DIR" ] || [ -z "$(ls -A "$BACKUP_DIR"/*.tar.gz 2>/dev/null)" ]; then
              echo "No backups found in $BACKUP_DIR"
              exit 1
            fi
            
            echo "Available backups:"
            ls -lht "$BACKUP_DIR"/*.tar.gz | nl
            echo ""
            
            read -p "Enter backup filename to restore: " BACKUP_FILE
            
            if [ ! -f "$BACKUP_DIR/$BACKUP_FILE" ]; then
              echo "Backup not found: $BACKUP_DIR/$BACKUP_FILE"
              exit 1
            fi
            
            echo ""
            echo "WARNING: This will replace current NiFi data!"
            read -p "Continue? (yes/NO): " CONFIRM
            
            if [ "$CONFIRM" != "yes" ]; then
              echo "Recovery cancelled"
              exit 0
            fi
            
            echo ""
            echo "Stopping NiFi containers..."
            cd "$NIFI_HOME"
            docker compose -f compose.{{ environment_name }}.yml down
            
            echo "Creating pre-recovery backup..."
            RECOVERY_BACKUP="$BACKUP_DIR/pre-recovery-$(date +%Y%m%d_%H%M%S).tar.gz"
            tar -czf "$RECOVERY_BACKUP" -C "$NIFI_HOME" flows/ registry_data/ 2>/dev/null || true
            
            echo "Restoring backup: $BACKUP_FILE"
            tar -xzf "$BACKUP_DIR/$BACKUP_FILE" -C "$NIFI_HOME"
            
            if [ $? -eq 0 ]; then
              echo "✓ Backup restored successfully"
              echo ""
              echo "Starting NiFi containers..."
              docker compose -f compose.{{ environment_name }}.yml up -d
              echo ""
              echo "Recovery complete!"
              echo "Monitor logs: docker compose -f compose.{{ environment_name }}.yml logs -f"
            else
              echo "✗ Recovery failed"
              exit 1
            fi

        - name: maintenance-report.sh
          content: |
            #!/bin/bash
            NIFI_HOME="{{ nifi_home }}"
            BACKUP_DIR="/home/{{ nifi_user }}/backups/{{ environment_name }}"
            
            cat <<EOF
            ================================================
            NiFi CI/CD Maintenance Report
            ================================================
            Generated: $(date)
            Environment: {{ environment_name }}
            Hostname: $(hostname)
            
            SYSTEM RESOURCES
            ================================================
            Disk Usage (NiFi Home): $(df -h "$NIFI_HOME" | awk 'NR==2 {print $5 " used of " $2}')
            Memory Usage: $(free -h | awk 'NR==2 {print $3 " / " $2}')
            CPU Load: $(uptime | awk -F'load average:' '{print $2}')
            
            DOCKER STATUS
            ================================================
            Images: $(docker images | wc -l) total
            Running Containers: $(docker ps --filter name=nifi | wc -l)
            Container Status:
            $(docker ps --filter name=nifi --format "  - {{.Names}}: {{.Status}}")
            
            GIT STATUS
            ================================================
            Branch: $(cd "$NIFI_HOME" && git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "N/A")
            Last 5 Commits:
            $(cd "$NIFI_HOME" && git log --oneline -5 2>/dev/null | sed 's/^/  /')
            
            BACKUP STATUS
            ================================================
            Backup Directory: $BACKUP_DIR
            Total Backups: $(ls "$BACKUP_DIR"/*.tar.gz 2>/dev/null | wc -l)
            Latest Backup: $(ls -t "$BACKUP_DIR"/*.tar.gz 2>/dev/null | head -1 | xargs basename)
            Backup Size: $(du -sh "$BACKUP_DIR" 2>/dev/null | cut -f1)
            
            SECURITY STATUS
            ================================================
            GitHub PAT: $([ -n "$GITHUB_PAT" ] && echo "✓ Configured" || echo "✗ Missing")
            Git Hook: $([ -x "$NIFI_HOME/.git/hooks/post-commit" ] && echo "✓ Active" || echo "✗ Inactive")
            Git Identity: $(git config --global user.name 2>/dev/null || echo "Not configured")
            
            RECOMMENDATIONS
            ================================================
            - Review and rotate GitHub PAT every 90 days
            - Verify backup integrity monthly
            - Update Docker images quarterly
            - Monitor disk usage weekly
            - Review git commits for proper attribution
            
            EOF

        - name: integration-test.sh
          content: |
            #!/bin/bash
            NIFI_HOME="{{ nifi_home }}"
            ERRORS=0
            
            echo "========================================"
            echo "  NiFi CI/CD Integration Tests"
            echo "========================================"
            echo ""
            
            # Test 1: Docker accessibility
            echo -n "Test 1: Docker accessible... "
            if docker ps >/dev/null 2>&1; then
              echo "✓ PASS"
            else
              echo "✗ FAIL"
              ERRORS=$((ERRORS + 1))
            fi
            
            # Test 2: Git hook installed
            echo -n "Test 2: Git hook installed... "
            if [ -x "$NIFI_HOME/.git/hooks/post-commit" ]; then
              echo "✓ PASS"
            else
              echo "✗ FAIL"
              ERRORS=$((ERRORS + 1))
            fi
            
            # Test 3: Environment variables
            echo -n "Test 3: Environment configured... "
            source ~/.nifi_cicd_env 2>/dev/null
            if [ -n "$GITHUB_REPO" ] && [ -n "$GITHUB_PAT" ]; then
              echo "✓ PASS"
            else
              echo "✗ FAIL"
              ERRORS=$((ERRORS + 1))
            fi
            
            # Test 4: GitHub API connectivity
            echo -n "Test 4: GitHub API accessible... "
            if curl -s -H "Authorization: token $GITHUB_PAT" \
              "https://api.github.com/rate_limit" | jq -e '.rate.remaining > 0' >/dev/null 2>&1; then
              echo "✓ PASS"
            else
              echo "✗ FAIL"
              ERRORS=$((ERRORS + 1))
            fi
            
            # Test 5: NiFi ports available
            echo -n "Test 5: NiFi port {{ nifi_https_port }} available... "
            if ! netstat -tuln 2>/dev/null | grep -q ":{{ nifi_https_port }}"; then
              echo "✓ PASS"
            else
              echo "⚠ WARNING (port in use)"
            fi
            
            # Test 6: Git identity configured
            echo -n "Test 6: Git identity configured... "
            if [ -n "$(git config --global user.name)" ] && [ -n "$(git config --global user.email)" ]; then
              echo "✓ PASS"
            else
              echo "⚠ WARNING (run ~/setup-my-identity.sh)"
            fi
            
            # Test 7: Backup directory writable
            echo -n "Test 7: Backup directory writable... "
            if [ -w "/home/{{ nifi_user }}/backups/{{ environment_name }}" ]; then
              echo "✓ PASS"
            else
              echo "✗ FAIL"
              ERRORS=$((ERRORS + 1))
            fi
            
            echo ""
            if [ $ERRORS -eq 0 ]; then
              echo "========================================="
              echo "  All tests passed! ✓"
              echo "========================================="
              exit 0
            else
              echo "========================================="
              echo "  $ERRORS test(s) failed"
              echo "========================================="
              exit 1
            fi