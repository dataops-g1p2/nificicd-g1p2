name: Share VM Access with Developers

on:
  workflow_dispatch:
    inputs:
      environments:
        description: 'Environments (comma-separated: development,staging,production)'
        required: true
        type: string
        default: 'development'

permissions:
  contents: read
  actions: read

jobs:
  parse-environments:
    name: Parse Environments
    runs-on: ubuntu-22.04
    outputs:
      environments: ${{ steps.parse.outputs.environments }}
    steps:
      - name: Parse Environment Input
        id: parse
        run: |
          INPUT="${{ github.event.inputs.environments }}"
          INPUT=$(echo "$INPUT" | tr -d ' ' | tr '[:upper:]' '[:lower:]')
          IFS=',' read -ra ENV_ARRAY <<< "$INPUT"
          
          VALID_ENVS=()
          for env in "${ENV_ARRAY[@]}"; do
            case "$env" in
              development|staging|production)
                [[ ! " ${VALID_ENVS[@]} " =~ " ${env} " ]] && VALID_ENVS+=("$env")
                ;;
            esac
          done
          
          JSON_ARRAY=$(printf '%s\n' "${VALID_ENVS[@]}" | jq -R . | jq -s .)
          echo "environments=$JSON_ARRAY" >> $GITHUB_OUTPUT

  generate-access:
    name: Generate Access - ${{ matrix.environment }}
    needs: parse-environments
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        environment: ${{ fromJson(needs.parse-environments.outputs.environments) }}
      fail-fast: false
    environment: ${{ matrix.environment }}
    steps:
      - name: Set VM Configuration
        id: config
        run: |
          ENV="${{ matrix.environment }}"
          echo "resource_group=rg-nificicd-g1p2-${ENV/development/dev}" >> $GITHUB_OUTPUT
          echo "vm_name=vm-nifi-${ENV}" >> $GITHUB_OUTPUT

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.ARM_CLIENT_ID }}",
              "clientSecret": "${{ secrets.ARM_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.ARM_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.ARM_TENANT_ID }}"
            }

      - name: Get VM Information
        id: vm_info
        run: |
          RG="${{ steps.config.outputs.resource_group }}"
          VM_NAME="${{ steps.config.outputs.vm_name }}"
          
          if ! az vm show --resource-group $RG --name $VM_NAME &>/dev/null; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "VM does not exist: $VM_NAME"
            exit 0
          fi
          
          VM_IP=$(az vm show -d --resource-group $RG --name $VM_NAME --query publicIps -o tsv)
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "ip=$VM_IP" >> $GITHUB_OUTPUT

      - name: Create Access Package
        if: steps.vm_info.outputs.exists == 'true'
        run: |
          ENV="${{ matrix.environment }}"
          VM_IP="${{ steps.vm_info.outputs.ip }}"
          USERNAME="${{ secrets.VM_USERNAME }}"
          NIFI_USER="${{ secrets.NIFI_USERNAME }}"
          NIFI_URL="${{ secrets.NIFI_URL }}"
          REGISTRY_URL="${{ secrets.REGISTRY_URL }}"
          
          mkdir -p "${ENV}-access"
          
          # Save SSH private key
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > "${ENV}-access/${ENV}-key.pem"
          chmod 600 "${ENV}-access/${ENV}-key.pem"
          
          # Create comprehensive README
          cat > "${ENV}-access/README.txt" <<EOF
          ===============================================================================
                              NiFi VM Access - ${ENV^^} Environment
          ===============================================================================

          VM INFORMATION:
            IP: ${VM_IP}
            Username: ${USERNAME}
            SSH Key: ${ENV}-key.pem

          IMPORTANT FIRST STEP
          
          After connecting, IMMEDIATELY run:
              ~/setup-my-identity.sh
          
          This configures YOUR Git identity so commits/PRs are attributed to YOU.
          Use your GitHub email for proper attribution!

          ===============================================================================
          CONNECTION METHODS
          ===============================================================================

          WINDOWS:
            • Double-click: connect.bat (easiest)
            • PowerShell: .\connect.ps1
            • WSL: chmod 600 ${ENV}-key.pem && ./connect.sh
            • PuTTY: Convert key with puttygen.exe, then use ${VM_IP}

          macOS/LINUX:
            • Run: ./connect.sh
            • Manual: chmod 600 ${ENV}-key.pem && ssh -i ${ENV}-key.pem ${USERNAME}@${VM_IP}

          ===============================================================================
          FIRST TIME SETUP
          ===============================================================================

          1. Configure Identity (REQUIRED):
             ~/setup-my-identity.sh
             
             Enter your full name and GitHub email when prompted.

          2. Verify Configuration:
             nifi_check_config

          3. Test Your Setup:
             cd ~/nificicd-g1p2
             echo "test by \$(git config user.name)" >> flows/test.txt
             git add flows/test.txt && git commit -m "test: verify identity"
             git log -1 --format="%an <%ae>"  # Should show YOUR name!

          ===============================================================================
          NIFI SERVICES & WORKFLOW
          ===============================================================================

          NiFi UI: ${NIFI_URL:-https://${VM_IP}:8443/nifi}
            Username: ${NIFI_USER}
            Password: (ask team lead)
            
          Registry: ${REGISTRY_URL:-http://${VM_IP}:18080/nifi-registry}

          Workflow:
            1. Make changes in NiFi UI
            2. NiFi Registry commits automatically
            3. Post-commit hook triggers GitHub Actions
            4. PR is created with YOUR name
            5. Team reviews and merges

          Monitor: https://github.com/${{ github.repository }}/actions

          ===============================================================================
          QUICK COMMANDS
          ===============================================================================

          Check Identity:
            git config --global user.name
            git config --global user.email

          Check Status:
            nifi_check_config

          Navigate:
            cd ~/nificicd-g1p2

          Test Webhook:
            nifi_trigger_workflow "test"

          View Workflows:
            gh run list && gh run watch

          Docker Status:
            cd ~/nificicd-g1p2
            sudo docker compose -f compose.${ENV}.yml ps
            sudo docker compose -f compose.${ENV}.yml logs -f nifi

          ===============================================================================
          TROUBLESHOOTING
          ===============================================================================

          Identity shows wrong name:
            → Run ~/setup-my-identity.sh again

          Windows SSH not found:
            → Settings → Apps → Optional Features → Add OpenSSH Client
            → Or use WSL: wsl ./connect.sh

          Permission denied:
            → Windows: Run as Administrator
            → Mac/Linux: chmod 600 ${ENV}-key.pem

          Connection timeout:
            → Check VM is running in Azure Portal
            → Verify firewall allows your IP

          ===============================================================================
          SECURITY NOTES
          ===============================================================================

          • Never commit SSH keys to Git
          • Share via encrypted channels only
          • Delete keys when no longer needed
          • Artifacts expire in 7 days

          ===============================================================================
          EOF
          
          # Create connection scripts with template function
          create_script() {
            local template=$1
            local file=$2
            echo "$template" > "${ENV}-access/$file"
            sed -i "s/ENV_PLACEHOLDER/${ENV}/g; s/IP_PLACEHOLDER/${VM_IP}/g; s/USER_PLACEHOLDER/${USERNAME}/g" "${ENV}-access/$file"
            [[ $file == *.sh ]] && chmod +x "${ENV}-access/$file"
          }
          
          # Bash script
          create_script '#!/bin/bash
          set -e
          ENV="ENV_PLACEHOLDER"
          VM_IP="IP_PLACEHOLDER"
          USERNAME="USER_PLACEHOLDER"
          KEY="ENV_PLACEHOLDER-key.pem"

          echo "====================================================="
          echo "  Connecting to ${ENV} VM"
          echo "====================================================="

          [ ! -f "$KEY" ] && { echo "ERROR: SSH key not found: $KEY"; exit 1; }

          chmod 600 "$KEY"
          echo -e "\nAFTER CONNECTING, RUN: ~/setup-my-identity.sh\n"
          ssh -i "$KEY" -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "${USERNAME}@${VM_IP}"' connect.sh
          
          # Batch script
          create_script '@echo off
          set ENV=ENV_PLACEHOLDER
          set VM_IP=IP_PLACEHOLDER
          set USERNAME=USER_PLACEHOLDER
          set KEY=ENV_PLACEHOLDER-key.pem

          echo =====================================================
          echo   Connecting to %ENV% VM
          echo =====================================================

          if not exist "%KEY%" (
              echo ERROR: SSH key not found: %KEY%
              pause & exit /b 1
          )

          where ssh >nul 2>&1 || (
              echo ERROR: Install OpenSSH via Settings -^> Apps -^> Optional Features
              pause & exit /b 1
          )

          echo.
          echo WARNING: After connecting, run: ~/setup-my-identity.sh
          echo.
          ssh -i "%KEY%" -o StrictHostKeyChecking=no -o UserKnownHostsFile=NUL %USERNAME%@%VM_IP%

          if %ERRORLEVEL% NEQ 0 (
              echo ERROR: Connection failed. Try: .\connect.ps1 or wsl ./connect.sh
              pause
          )' connect.bat
          
          # PowerShell script
          create_script '$ErrorActionPreference = "Stop"
          $ENV_NAME = "ENV_PLACEHOLDER"
          $VM_IP = "IP_PLACEHOLDER"
          $USERNAME = "USER_PLACEHOLDER"
          $KEY = "ENV_PLACEHOLDER-key.pem"

          Write-Host "=====================================================" -ForegroundColor Cyan
          Write-Host "  Connecting to $ENV_NAME VM" -ForegroundColor Cyan
          Write-Host "=====================================================" -ForegroundColor Cyan

          if (-not (Test-Path $KEY)) {
              Write-Host "ERROR: SSH key not found: $KEY" -ForegroundColor Red
              Read-Host "Press Enter to exit"
              exit 1
          }

          if (-not (Get-Command ssh -ErrorAction SilentlyContinue)) {
              Write-Host "ERROR: Install OpenSSH via Settings -> Apps -> Optional Features" -ForegroundColor Red
              Read-Host "Press Enter to exit"
              exit 1
          }

          icacls $KEY /inheritance:r /grant:r "$($env:USERNAME):(R)" | Out-Null
          Write-Host "`nAfter connecting, run: ~/setup-my-identity.sh`n" -ForegroundColor Yellow

          try {
              ssh -i $KEY -o StrictHostKeyChecking=no -o UserKnownHostsFile=NUL "${USERNAME}@${VM_IP}"
          } catch {
              Write-Host "ERROR: Connection failed: $_" -ForegroundColor Red
              Read-Host "Press Enter to exit"
              exit 1
          }' connect.ps1

          # Create archive
          cd "${ENV}-access" && zip -j "../${ENV}-vm-access.zip" ./* && cd ..
          echo "Access package created for ${ENV}"

      - name: Upload Access Package
        if: steps.vm_info.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.environment }}-vm-access
          path: ${{ matrix.environment }}-vm-access.zip
          retention-days: 7

      - name: Job Summary
        if: steps.vm_info.outputs.exists == 'true'
        run: |
          ENV="${{ matrix.environment }}"
          echo "**${ENV^^} VM Access Ready**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **VM:** ${{ secrets.VM_USERNAME }}@${{ steps.vm_info.outputs.ip }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Download:** ${ENV}-vm-access.zip from Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **After connecting:** Run \`~/setup-my-identity.sh\`" >> $GITHUB_STEP_SUMMARY
  summary:
    name: Workflow Summary
    needs: [parse-environments, generate-access]
    if: always()
    runs-on: ubuntu-22.04
    steps:
      - name: Final Summary
        run: |
          cat << 'EOF'
          
          ================================================
                    VM Access Packages Ready
          ================================================
          
          DOWNLOAD: Actions → This Run → Artifacts
          
          IMPORTANT: Each developer MUST run this after connecting:
              ~/setup-my-identity.sh
          
          USAGE:
            1. Download and extract zip
            2. Windows: Double-click connect.bat
               Mac/Linux: Run ./connect.sh
            3. REQUIRED: ~/setup-my-identity.sh
            4. Verify: nifi_check_config
          
          WHY: Ensures commits/PRs are attributed to YOU
          
          SECURITY:
            • Share via encrypted channels only
            • Artifacts expire in 7 days
          
          EOF