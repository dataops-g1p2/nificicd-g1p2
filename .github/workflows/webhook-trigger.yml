name: VM Registry Commit Trigger

on:
  repository_dispatch:
    types: [vm-registry-commit]

  workflow_dispatch:
    inputs:
      source_vm:
        description: 'Source VM environment'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      commit_message:
        description: 'Commit message from VM'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  sync-from-vm:
    name: Sync Changes from VM
    runs-on: ubuntu-22.04
    environment: ${{ github.event.client_payload.environment || github.event.inputs.source_vm }}
    steps:

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: Get VM Configuration
        id: config
        run: |
          ENV="${{ github.event.client_payload.environment || github.event.inputs.source_vm }}"

          case $ENV in
            development)
              echo "branch=develop" >> $GITHUB_OUTPUT
              echo "resource_group=rg-nificicd-g1p2-dev" >> $GITHUB_OUTPUT
              echo "vm_name=vm-nifi-development" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "branch=staging" >> $GITHUB_OUTPUT
              echo "resource_group=rg-nificicd-g1p2-staging" >> $GITHUB_OUTPUT
              echo "vm_name=vm-nifi-staging" >> $GITHUB_OUTPUT
              ;;
            production)
              echo "branch=main" >> $GITHUB_OUTPUT
              echo "resource_group=rg-nificicd-g1p2-prod" >> $GITHUB_OUTPUT
              echo "vm_name=vm-nifi-production" >> $GITHUB_OUTPUT
              ;;
          esac

          echo "environment=$ENV" >> $GITHUB_OUTPUT

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.ARM_CLIENT_ID }}",
              "clientSecret": "${{ secrets.ARM_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.ARM_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.ARM_TENANT_ID }}"
            }

      - name: Get VM IP
        id: vm_ip
        run: |
          VM_IP=$(az vm show \
            --resource-group ${{ steps.config.outputs.resource_group }} \
            --name ${{ steps.config.outputs.vm_name }} \
            --show-details \
            --query publicIps \
            -o tsv 2>/dev/null || echo "")

          if [ -z "$VM_IP" ]; then
            echo "VM not found or not running"
            exit 1
          fi

          echo "ip=$VM_IP" >> $GITHUB_OUTPUT
          echo "VM IP retrieved"

      - name: Test SSH Connection
        run: |
          VM_IP="${{ steps.vm_ip.outputs.ip }}"
          VM_USER="${{ secrets.VM_USERNAME }}"

          ssh-keyscan -H $VM_IP >> ~/.ssh/known_hosts 2>/dev/null || true

          for i in {1..3}; do
            if ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
              $VM_USER@$VM_IP "echo 'SSH connected'" 2>/dev/null; then
              echo "SSH connection successful"
              exit 0
            fi
            echo "Attempt $i/3 failed, waiting..."
            [ $i -lt 3 ] && sleep 10
          done
          echo "SSH connection failed"
          exit 1

      - name: Pull Changes from VM
        run: |
          VM_IP="${{ steps.vm_ip.outputs.ip }}"
          VM_USER="${{ secrets.VM_USERNAME }}"

          sudo apt-get update -qq && sudo apt-get install -y rsync 2>/dev/null || true

          echo "Pulling changes from VM..."

          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
            --include='flows/' \
            --include='flows/**' \
            --include='registry_data/' \
            --include='registry_data/**' \
            --exclude='*' \
            $VM_USER@$VM_IP:~/nificicd-g1p2/ ./

          echo "Changes synced from VM"
          echo "  Flows: $(find flows -type f 2>/dev/null | wc -l) files"
          echo "  Registry: $(find registry_data -type f 2>/dev/null | wc -l) files"

      - name: Configure Git
        run: |
          git config user.name "nifi-vm-sync[bot]"
          git config user.email "nifi-vm-sync[bot]@users.noreply.github.com"

      - name: Determine Branch Strategy
        id: branch_strategy
        run: |
          SOURCE_BRANCH="${{ github.event.client_payload.branch || 'develop' }}"
          ENV="${{ steps.config.outputs.environment }}"
          IS_FEATURE_BRANCH="${{ github.event.client_payload.is_feature_branch || 'false' }}"
          
          echo "source_branch=$SOURCE_BRANCH" >> $GITHUB_OUTPUT
          
          # Determine target branch based on branch type
          if [ "$IS_FEATURE_BRANCH" = "true" ]; then
            # Feature branches always target develop
            TARGET_BRANCH="develop"
            echo "ğŸŒ¿ Feature branch detected: $SOURCE_BRANCH â†’ develop"
          else
            # Environment branches use their configured target
            TARGET_BRANCH="${{ steps.config.outputs.branch }}"
            echo "ğŸ“¦ Environment branch: $SOURCE_BRANCH â†’ $TARGET_BRANCH"
          fi
          
          echo "target_branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT
          echo "is_feature_branch=$IS_FEATURE_BRANCH" >> $GITHUB_OUTPUT

      - name: Create PR Branch and Commit Changes
        id: commit_changes
        run: |
          SOURCE_BRANCH="${{ steps.branch_strategy.outputs.source_branch }}"
          TARGET_BRANCH="${{ steps.branch_strategy.outputs.target_branch }}"
          IS_FEATURE_BRANCH="${{ steps.branch_strategy.outputs.is_feature_branch }}"
          ENV="${{ steps.config.outputs.environment }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          
          # Create PR branch name based on source
          if [ "$IS_FEATURE_BRANCH" = "true" ]; then
            # For feature branches, use the source branch name in PR branch
            FEATURE_NAME=$(echo "$SOURCE_BRANCH" | sed 's/feature\///' | sed 's/hotfix\///' | sed 's/bugfix\///' | sed 's/\//-/g')
            PR_BRANCH="vm-sync/${ENV}/${FEATURE_NAME}/${TIMESTAMP}"
          else
            # For environment branches, use standard naming
            PR_BRANCH="vm-sync/${ENV}/${TIMESTAMP}"
          fi

          echo "ğŸ¯ Source branch: $SOURCE_BRANCH"
          echo "ğŸ¯ Target branch: $TARGET_BRANCH"
          echo "ğŸŒ¿ PR branch: $PR_BRANCH"

          # Fetch all branches
          git fetch origin

          # Delete PR branch if it exists remotely (cleanup old attempts)
          git push origin --delete "$PR_BRANCH" 2>/dev/null || true

          # Create PR branch from target
          git checkout -b "$PR_BRANCH" "origin/$TARGET_BRANCH"

          # Stage changes
          git add flows/ registry_data/ 2>/dev/null || true

          # Check for changes
          if git diff --cached --quiet; then
            echo "â„¹ï¸ No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Build commit message
          COMMIT_MSG="${{ github.event.client_payload.commit_message || github.event.inputs.commit_message || 'Sync from VM registry' }}"
          VM_COMMIT="${{ github.event.client_payload.commit_sha || 'N/A' }}"
          VM_AUTHOR="${{ github.event.client_payload.commit_author || 'N/A' }}"
          VM_HOSTNAME="${{ github.event.client_payload.vm_hostname || 'N/A' }}"

          # Create commit with branch info
          if [ "$IS_FEATURE_BRANCH" = "true" ]; then
            git commit -m "VM Sync [$SOURCE_BRANCH]: $COMMIT_MSG" -m "
          Source Branch: $SOURCE_BRANCH
          Target Branch: $TARGET_BRANCH
          Environment: $ENV (${{ steps.config.outputs.vm_name }})
          VM Commit: ${VM_COMMIT}
          VM Author: ${VM_AUTHOR}
          VM Hostname: ${VM_HOSTNAME}
          Workflow Run: #${{ github.run_number }}
          Triggered: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          else
            git commit -m "VM Sync: $COMMIT_MSG" -m "
          Source: $ENV environment (${{ steps.config.outputs.vm_name }})
          VM Commit: ${VM_COMMIT}
          VM Author: ${VM_AUTHOR}
          VM Hostname: ${VM_HOSTNAME}
          Workflow Run: #${{ github.run_number }}
          Triggered: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          fi

          # Push PR branch (NOT protected branch)
          echo "ğŸ“¤ Pushing to: $PR_BRANCH (safe, not protected)"
          git push origin "$PR_BRANCH"

          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "pr_branch=$PR_BRANCH" >> $GITHUB_OUTPUT
          echo "source_branch=$SOURCE_BRANCH" >> $GITHUB_OUTPUT
          echo "target_branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT
          echo "âœ… Changes committed to PR branch"

      - name: Ensure PR Labels Exist
        if: steps.commit_changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Create labels if they don't exist
          gh label create "vm-sync" --color "0E8A16" --description "Automated VM sync" --force 2>/dev/null || true
          gh label create "automated" --color "FBCA04" --description "Automated workflow" --force 2>/dev/null || true
          gh label create "development" --color "1D76DB" --description "Development environment" --force 2>/dev/null || true
          gh label create "staging" --color "FB8500" --description "Staging environment" --force 2>/dev/null || true
          gh label create "production" --color "D93F0B" --description "Production environment" --force 2>/dev/null || true
          echo "âœ… Labels verified/created"

      - name: Create Pull Request
        if: steps.commit_changes.outputs.has_changes == 'true'
        id: create_pr
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          SOURCE_BRANCH="${{ steps.commit_changes.outputs.source_branch }}"
          TARGET_BRANCH="${{ steps.commit_changes.outputs.target_branch }}"
          PR_BRANCH="${{ steps.commit_changes.outputs.pr_branch }}"
          IS_FEATURE_BRANCH="${{ steps.branch_strategy.outputs.is_feature_branch }}"
          ENV="${{ steps.config.outputs.environment }}"

          COMMIT_MSG="${{ github.event.client_payload.commit_message || github.event.inputs.commit_message || 'Sync from VM registry' }}"
          VM_COMMIT="${{ github.event.client_payload.commit_sha || 'N/A' }}"
          VM_AUTHOR="${{ github.event.client_payload.commit_author || 'N/A' }}"

          # Build PR body
          if [ "$IS_FEATURE_BRANCH" = "true" ]; then
            PR_TITLE="ğŸŒ¿ VM Sync [${SOURCE_BRANCH}]: $COMMIT_MSG"
            PR_BODY="## ğŸŒ¿ Feature Branch VM Sync

          **Source Branch:** \`$SOURCE_BRANCH\`
          **Target Branch:** \`$TARGET_BRANCH\`
          **Environment:** \`$ENV\`
          **VM Commit:** \`${VM_COMMIT}\`
          **VM Author:** ${VM_AUTHOR}

          ### ğŸ“ Changes
          This PR contains NiFi flow and registry changes from the **$SOURCE_BRANCH** feature branch on the **$ENV** VM.

          **Commit Message:** $COMMIT_MSG

          ### ğŸš€ After Merging
          - âœ… Changes will be merged to \`$TARGET_BRANCH\`
          - ğŸ”„ Deployment workflow will trigger automatically
          - ğŸ“¦ NiFi will be updated in $ENV environment

          ---
          *ğŸ¤– Automated sync from VM feature branch - Workflow run [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*"
          else
            PR_TITLE="ğŸ“„ VM Sync [$ENV]: $COMMIT_MSG"
            PR_BODY="## ğŸ“„ VM Registry Sync

          **Environment:** \`$ENV\`
          **Target Branch:** \`$TARGET_BRANCH\`
          **VM Commit:** \`${VM_COMMIT}\`
          **VM Author:** ${VM_AUTHOR}

          ### ğŸ“ Changes
          This PR contains NiFi flow and registry changes synced from the **$ENV** VM.

          **Commit Message:** $COMMIT_MSG

          ### ğŸš€ After Merging
          - âœ… Changes will be merged to \`$TARGET_BRANCH\`
          - ğŸ”„ Deployment workflow will trigger automatically
          - ğŸ“¦ NiFi will be updated in $ENV environment

          ---
          *ğŸ¤– Automated sync from VM - Workflow run [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*"
          fi

          # Check if PR already exists for this branch
          EXISTING_PR=$(gh pr list --head "$PR_BRANCH" --base "$TARGET_BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "â„¹ï¸ PR already exists: #$EXISTING_PR"
            PR_URL="https://github.com/${{ github.repository }}/pull/$EXISTING_PR"
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Create PR
          echo "ğŸ“‹ Creating pull request..."
          PR_URL=$(gh pr create \
            --title "$PR_TITLE" \
            --body "$PR_BODY" \
            --base "$TARGET_BRANCH" \
            --head "$PR_BRANCH" \
            --label "vm-sync" \
            --label "automated" \
            --label "$ENV" 2>&1)

          if [ $? -eq 0 ]; then
            echo "âœ… Pull Request created"
            echo "$PR_URL"

            # Get PR number
            PR_NUMBER=$(echo "$PR_URL" | grep -oP 'pull/\K[0-9]+' || gh pr list --head "$PR_BRANCH" --json number --jq '.[0].number')
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          else
            echo "âŒ Failed to create PR"
            echo "$PR_URL"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key

      - name: Summary
        if: steps.commit_changes.outputs.has_changes == 'true'
        run: |
          SOURCE_BRANCH="${{ steps.commit_changes.outputs.source_branch }}"
          TARGET_BRANCH="${{ steps.commit_changes.outputs.target_branch }}"
          IS_FEATURE_BRANCH="${{ steps.branch_strategy.outputs.is_feature_branch }}"
          ENV="${{ steps.config.outputs.environment }}"
          PR_URL="${{ steps.create_pr.outputs.pr_url }}"

          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âœ… VM Sync Complete (PR Created) â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          if [ "$IS_FEATURE_BRANCH" = "true" ]; then
            echo "ğŸŒ¿ Feature Branch: $SOURCE_BRANCH"
          fi
          
          echo "ğŸ“ Environment: $ENV"
          echo "ğŸ¯ Target Branch: $TARGET_BRANCH"
          echo ""
          echo "ğŸ“‹ Pull Request:"
          echo "   $PR_URL"
          echo ""
          echo "ğŸ“Œ Next Steps:"
          echo "   1. Review the PR (link above)"
          echo "   2. Merge the PR when ready"
          echo "   3. Deployment will trigger automatically"
          echo ""

      - name: Summary - No Changes
        if: steps.commit_changes.outputs.has_changes == 'false'
        run: |
          echo ""
          echo "â„¹ï¸ No changes detected"
          echo "The VM state matches the current Git state"
          echo ""