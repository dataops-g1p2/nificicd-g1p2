name: VM Registry Commit Trigger

on:
  repository_dispatch:
    types: [vm-registry-commit]

  workflow_dispatch:
    inputs:
      source_vm:
        description: 'Source VM environment'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      commit_message:
        description: 'Commit message from VM'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  sync-from-vm:
    name: Sync Changes from VM
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    environment: ${{ github.event.client_payload.environment || github.event.inputs.source_vm }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: Get VM Configuration
        id: config
        run: |
          ENV="${{ github.event.client_payload.environment || github.event.inputs.source_vm }}"
          
          # Set branch based on environment
          case $ENV in
            development) BRANCH="develop" ;;
            staging) BRANCH="staging" ;;
            production) BRANCH="main" ;;
          esac
          
          # Set resource group and VM name
          RG_SUFFIX="${ENV/development/dev}"
          
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "resource_group=rg-nificicd-g1p2-$RG_SUFFIX" >> $GITHUB_OUTPUT
          echo "vm_name=vm-nifi-$ENV" >> $GITHUB_OUTPUT
          echo "environment=$ENV" >> $GITHUB_OUTPUT

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.ARM_CLIENT_ID }}",
              "clientSecret": "${{ secrets.ARM_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.ARM_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.ARM_TENANT_ID }}"
            }

      - name: Get VM IP and Test Connection
        id: vm_connect
        run: |
          VM_IP=$(az vm show \
            --resource-group ${{ steps.config.outputs.resource_group }} \
            --name ${{ steps.config.outputs.vm_name }} \
            --show-details \
            --query publicIps \
            -o tsv 2>/dev/null || echo "")

          if [ -z "$VM_IP" ]; then
            echo "ERROR: VM not found or not running"
            exit 1
          fi
          
          echo "ip=$VM_IP" >> $GITHUB_OUTPUT
          echo "VM IP retrieved: $VM_IP"
          
          # Setup and test SSH connection
          VM_USER="${{ secrets.VM_USERNAME }}"
          ssh-keyscan -H $VM_IP >> ~/.ssh/known_hosts 2>/dev/null || true
          
          MAX_RETRIES=5
          for i in $(seq 1 $MAX_RETRIES); do
            if ssh -i ~/.ssh/deploy_key \
                   -o StrictHostKeyChecking=no \
                   -o UserKnownHostsFile=/dev/null \
                   -o ConnectTimeout=10 \
                   $VM_USER@$VM_IP "echo 'SSH connected'" 2>/dev/null; then
              echo "SSH connection successful"
              exit 0
            fi
            
            [ $i -lt $MAX_RETRIES ] && echo "Attempt $i/$MAX_RETRIES failed, waiting 10s..." && sleep 10
          done
          
          echo "ERROR: SSH connection failed after $MAX_RETRIES attempts"
          exit 1

      - name: Pull Changes from VM
        id: pull_changes
        run: |
          VM_IP="${{ steps.vm_connect.outputs.ip }}"
          VM_USER="${{ secrets.VM_USERNAME }}"

          sudo apt-get update -qq && sudo apt-get install -y rsync 2>/dev/null || true

          echo "Pulling changes from VM..."
          
          MAX_RETRIES=3
          for i in $(seq 1 $MAX_RETRIES); do
            if rsync -avz --delete \
              -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
              --include='flows/' --include='flows/**' \
              --include='registry_data/' --include='registry_data/**' \
              --exclude='*' \
              $VM_USER@$VM_IP:~/nificicd-g1p2/ ./; then
              
              echo "Changes synced successfully"
              echo "  Flows: $(find flows -type f 2>/dev/null | wc -l) files"
              echo "  Registry: $(find registry_data -type f 2>/dev/null | wc -l) files"
              exit 0
            fi
            
            [ $i -lt $MAX_RETRIES ] && echo "Retry $i/$MAX_RETRIES after 5 seconds..." && sleep 5
          done
          
          echo "ERROR: Failed to sync after $MAX_RETRIES attempts"
          exit 1

      - name: Configure Git
        run: |
          git config user.name "nifi-vm-sync[bot]"
          git config user.email "nifi-vm-sync[bot]@users.noreply.github.com"

      - name: Determine Branch Strategy and Parse Author
        id: branch_strategy
        run: |
          SOURCE_BRANCH="${{ github.event.client_payload.branch || 'develop' }}"
          ENV="${{ steps.config.outputs.environment }}"
          IS_FEATURE_BRANCH="${{ github.event.client_payload.is_feature_branch || 'false' }}"
          
          # Determine target branch
          if [ "$IS_FEATURE_BRANCH" = "true" ]; then
            TARGET_BRANCH="develop"
            echo "Feature branch detected: $SOURCE_BRANCH -> develop"
          else
            TARGET_BRANCH="${{ steps.config.outputs.branch }}"
            echo "Environment branch: $SOURCE_BRANCH -> $TARGET_BRANCH"
          fi
          
          # Parse author information
          REAL_AUTHOR="${{ github.event.client_payload.commit_author }}"
          
          if [[ "$REAL_AUTHOR" =~ ^(.+)\ \<(.+)\>$ ]]; then
            AUTHOR_NAME="${BASH_REMATCH[1]}"
            AUTHOR_EMAIL="${BASH_REMATCH[2]}"
          else
            AUTHOR_NAME=$(git log -1 --format="%an" 2>/dev/null || echo "Developer")
            AUTHOR_EMAIL=$(git log -1 --format="%ae" 2>/dev/null || echo "developer@unknown.local")
            REAL_AUTHOR="$AUTHOR_NAME <$AUTHOR_EMAIL>"
          fi
          
          echo "source_branch=$SOURCE_BRANCH" >> $GITHUB_OUTPUT
          echo "target_branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT
          echo "is_feature_branch=$IS_FEATURE_BRANCH" >> $GITHUB_OUTPUT
          echo "real_author=$REAL_AUTHOR" >> $GITHUB_OUTPUT
          echo "author_name=$AUTHOR_NAME" >> $GITHUB_OUTPUT
          echo "author_email=$AUTHOR_EMAIL" >> $GITHUB_OUTPUT

      - name: Create PR Branch and Commit
        id: commit_changes
        run: |
          SOURCE_BRANCH="${{ steps.branch_strategy.outputs.source_branch }}"
          TARGET_BRANCH="${{ steps.branch_strategy.outputs.target_branch }}"
          IS_FEATURE_BRANCH="${{ steps.branch_strategy.outputs.is_feature_branch }}"
          ENV="${{ steps.config.outputs.environment }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          
          # Create PR branch name
          if [ "$IS_FEATURE_BRANCH" = "true" ]; then
            FEATURE_NAME=$(echo "$SOURCE_BRANCH" | sed 's|.*/||; s|/|-|g')
            PR_BRANCH="vm-sync/${ENV}/${FEATURE_NAME}/${TIMESTAMP}"
          else
            PR_BRANCH="vm-sync/${ENV}/${TIMESTAMP}"
          fi

          echo "Source: $SOURCE_BRANCH | Target: $TARGET_BRANCH | PR: $PR_BRANCH"

          # Setup branch
          git fetch origin
          git push origin --delete "$PR_BRANCH" 2>/dev/null || true
          git checkout -b "$PR_BRANCH" "origin/$TARGET_BRANCH"

          # Stage changes
          git add flows/ registry_data/ 2>/dev/null || true

          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Auto-resolve conflicts (prefer VM version)
          if git diff --name-only --diff-filter=U | grep -q .; then
            echo "Conflicts detected. Auto-resolving (VM version preferred)..."
            git diff --name-only --diff-filter=U | xargs -I {} git checkout --theirs {}
            git add -u
            echo "Conflicts resolved"
          fi

          # Get commit metadata
          REAL_AUTHOR="${{ steps.branch_strategy.outputs.real_author }}"
          COMMIT_MSG="${{ github.event.client_payload.commit_message || github.event.inputs.commit_message || 'Sync from VM registry' }}"
          VM_COMMIT="${{ github.event.client_payload.commit_sha || 'N/A' }}"
          VM_HOSTNAME="${{ github.event.client_payload.vm_hostname || 'N/A' }}"
          
          # Build commit message
          if [ "$IS_FEATURE_BRANCH" = "true" ]; then
            TITLE="VM Sync [$SOURCE_BRANCH]: $COMMIT_MSG"
            BODY="Source Branch: $SOURCE_BRANCH
          Target Branch: $TARGET_BRANCH"
          else
            TITLE="VM Sync: $COMMIT_MSG"
            BODY="Source: $ENV environment (${{ steps.config.outputs.vm_name }})"
          fi
          
          # Create commit with co-author
          git commit -m "$TITLE" -m "$BODY
          VM Commit: ${VM_COMMIT}
          VM Hostname: ${VM_HOSTNAME}
          Workflow Run: #${{ github.run_number }}
          Triggered: $(date -u +%Y-%m-%dT%H:%M:%SZ)

          Co-authored-by: ${REAL_AUTHOR}"

          git push origin "$PR_BRANCH"

          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "pr_branch=$PR_BRANCH" >> $GITHUB_OUTPUT
          echo "Changes committed with developer attribution"

      - name: Ensure PR Labels and Create Pull Request
        if: steps.commit_changes.outputs.has_changes == 'true'
        id: create_pr
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Create labels if needed
          for label in "vm-sync:0E8A16:Automated VM sync" "automated:FBCA04:Automated workflow" \
                       "development:1D76DB:Development environment" "staging:FB8500:Staging environment" \
                       "production:D93F0B:Production environment"; do
            IFS=':' read -r name color desc <<< "$label"
            gh label create "$name" --color "$color" --description "$desc" --force 2>/dev/null || true
          done
          echo "Labels verified"
          
          # Get variables
          SOURCE_BRANCH="${{ steps.branch_strategy.outputs.source_branch }}"
          TARGET_BRANCH="${{ steps.branch_strategy.outputs.target_branch }}"
          PR_BRANCH="${{ steps.commit_changes.outputs.pr_branch }}"
          IS_FEATURE_BRANCH="${{ steps.branch_strategy.outputs.is_feature_branch }}"
          ENV="${{ steps.config.outputs.environment }}"
          COMMIT_MSG="${{ github.event.client_payload.commit_message || github.event.inputs.commit_message || 'Sync from VM registry' }}"
          VM_COMMIT="${{ github.event.client_payload.commit_sha || 'N/A' }}"
          REAL_AUTHOR="${{ steps.branch_strategy.outputs.real_author }}"
          AUTHOR_NAME="${{ steps.branch_strategy.outputs.author_name }}"
          AUTHOR_EMAIL="${{ steps.branch_strategy.outputs.author_email }}"
          VM_HOSTNAME="${{ github.event.client_payload.vm_hostname || 'N/A' }}"
          
          # Find GitHub username
          GITHUB_USER=""
          if [ "$AUTHOR_EMAIL" != "unknown" ] && [ "$AUTHOR_EMAIL" != "developer@unknown.local" ]; then
            GITHUB_USER=$(gh api search/users?q="${AUTHOR_EMAIL}+in:email" --jq '.items[0].login' 2>/dev/null || echo "")
          fi

          # Build PR title
          if [ -n "$GITHUB_USER" ]; then
            PR_TITLE="VM Sync [$ENV] by @$GITHUB_USER: $COMMIT_MSG"
          else
            PR_TITLE="VM Sync [$ENV] by $AUTHOR_NAME: $COMMIT_MSG"
          fi

          # Build PR body
          cat > pr_body.md <<EOF
          ## Developer: **$AUTHOR_NAME**
          $([ -n "$GITHUB_USER" ] && echo "**GitHub:** @$GITHUB_USER" || echo "**Email:** $AUTHOR_EMAIL")

          ## $([ "$IS_FEATURE_BRANCH" = "true" ] && echo "Feature Branch VM Sync" || echo "VM Registry Sync")

          $([ "$IS_FEATURE_BRANCH" = "true" ] && echo "**Source Branch:** \`$SOURCE_BRANCH\`")
          **$([ "$IS_FEATURE_BRANCH" = "true" ] && echo "Target" || echo "Environment"):** \`$([ "$IS_FEATURE_BRANCH" = "true" ] && echo "$TARGET_BRANCH" || echo "$ENV")\`

          ### Commit Details
          - **Author:** $REAL_AUTHOR
          - **VM Commit:** \`${VM_COMMIT}\`
          - **VM Hostname:** ${VM_HOSTNAME}
          - **Message:** $COMMIT_MSG

          ### Changes
          This PR contains NiFi flow and registry changes from the **$([ "$IS_FEATURE_BRANCH" = "true" ] && echo "$SOURCE_BRANCH feature branch on the " || echo "")$ENV** VM.

          ### After Merging
          - Changes will be merged to \`$TARGET_BRANCH\`
          - Deployment workflow will trigger automatically
          - NiFi will be updated in $ENV environment

          ---
          *Authored by: $AUTHOR_NAME | Automated sync - Workflow run [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
          EOF

          # Check for existing PR
          EXISTING_PR=$(gh pr list --head "$PR_BRANCH" --base "$TARGET_BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "PR already exists: #$EXISTING_PR"
            PR_URL="https://github.com/${{ github.repository }}/pull/$EXISTING_PR"
            PR_NUMBER="$EXISTING_PR"
          else
            # Create PR
            echo "Creating pull request with developer attribution..."
            PR_URL=$(gh pr create \
              --title "$PR_TITLE" \
              --body-file pr_body.md \
              --base "$TARGET_BRANCH" \
              --head "$PR_BRANCH" \
              --label "vm-sync" \
              --label "automated" \
              --label "$ENV")

            if [ $? -eq 0 ]; then
              echo "Pull Request created: $PR_URL"
              PR_NUMBER=$(echo "$PR_URL" | grep -oP 'pull/\K[0-9]+' || gh pr list --head "$PR_BRANCH" --json number --jq '.[0].number')
              
              # Request review from developer if found
              [ -n "$GITHUB_USER" ] && gh pr edit "$PR_NUMBER" --add-reviewer "$GITHUB_USER" 2>/dev/null && echo "Review requested from @$GITHUB_USER"
            else
              echo "ERROR: Failed to create PR"
              exit 1
            fi
          fi
          
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "github_user=$GITHUB_USER" >> $GITHUB_OUTPUT

      - name: Generate Summary and Output
        if: always()
        run: |
          HAS_CHANGES="${{ steps.commit_changes.outputs.has_changes }}"
          
          # Generate GitHub Step Summary
          cat > $GITHUB_STEP_SUMMARY <<EOF
          # VM Sync Summary
          
          ## Configuration
          - **Environment**: ${{ steps.config.outputs.environment }}
          - **Source Branch**: ${{ steps.branch_strategy.outputs.source_branch }}
          - **Target Branch**: ${{ steps.branch_strategy.outputs.target_branch }}
          - **VM**: ${{ steps.config.outputs.vm_name }}
          
          ## Developer
          - **Name**: ${{ steps.branch_strategy.outputs.author_name || 'N/A' }}
          - **Email**: ${{ steps.branch_strategy.outputs.author_email || 'N/A' }}
          $([ -n "${{ steps.create_pr.outputs.github_user }}" ] && echo "- **GitHub**: @${{ steps.create_pr.outputs.github_user }}" || echo "")
          
          ## Results
          - **Changes Detected**: ${HAS_CHANGES:-false}
          - **PR**: ${{ steps.create_pr.outputs.pr_url || 'No changes detected' }}
          
          ## Files Changed
          \`\`\`
          $(git diff --stat origin/${{ steps.branch_strategy.outputs.target_branch }} 2>/dev/null | head -20 || echo "No changes")
          \`\`\`
          EOF
          
          # Console output
          if [ "$HAS_CHANGES" = "true" ]; then
            ENV="${{ steps.config.outputs.environment }}"
            SOURCE_BRANCH="${{ steps.branch_strategy.outputs.source_branch }}"
            TARGET_BRANCH="${{ steps.branch_strategy.outputs.target_branch }}"
            IS_FEATURE_BRANCH="${{ steps.branch_strategy.outputs.is_feature_branch }}"
            AUTHOR_NAME="${{ steps.branch_strategy.outputs.author_name }}"
            PR_URL="${{ steps.create_pr.outputs.pr_url }}"

            cat <<SUMMARY
          
          ╔═════════════════════════════════╗
          ║  VM Sync Complete (PR Created)  ║
          ╚═════════════════════════════════╝
          
          $([ "$IS_FEATURE_BRANCH" = "true" ] && echo "Feature Branch: $SOURCE_BRANCH")
          Environment: $ENV
          Target Branch: $TARGET_BRANCH
          Developer: $AUTHOR_NAME
          
          Pull Request: $PR_URL
          
          Next Steps:
            1. Review the PR (link above)
            2. Merge the PR when ready
            3. Deployment will trigger automatically
          
          SUMMARY
          else
            echo -e "\nNo changes detected - VM state matches Git state\n"
          fi

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key
      
      - name: Notify on Failure
        if: failure()
        run: |
          echo "::warning::VM Sync failed for ${{ steps.config.outputs.environment }}"
          echo "Check the logs above for details"