# ========================================================================
# TERRAFORM MAKEFILE: Azure VM Infrastructure with Proper State Isolation
# ========================================================================
# Location: azure-vm-terraform/Makefile

MAKEFLAGS += --no-print-directory

# Environment mapping
ENV ?= development
ENV_MAP_dev := development
ENV_MAP_development := development

WORKSPACE := $(or $(ENV_MAP_$(ENV)),$(ENV))

# Paths
TFVARS_FILE := $(WORKSPACE).tfvars
BACKEND_CONFIG := backend-configs/$(WORKSPACE).tfbackend
ROOT_DIR := $(shell pwd)/..
ENV_FILE := $(ROOT_DIR)/.env.$(WORKSPACE)

.DEFAULT_GOAL := help

.PHONY: help init validate plan apply destroy output state update-secrets remove-secrets clean

help:
	@echo ""
	@echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
	@echo "|  Terraform Infrastructure Manager (State Isolated)  |"
	@echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
	@echo ""
	@echo "Usage: make [target] ENV=<environment>"
	@echo ""
	@echo "ğŸ“¦ SINGLE ENVIRONMENT OPERATIONS"
	@echo "  init              Initialize Terraform for environment"
	@echo "  validate          Validate Terraform configuration"
	@echo "  plan              Show execution plan"
	@echo "  apply             Apply infrastructure changes"
	@echo "  destroy           Destroy infrastructure"
	@echo "  output            Show outputs"
	@echo "  state             Show state list"
	@echo ""
	@echo "ğŸ” SECRETS MANAGEMENT"
	@echo "  update-secrets         Update GitHub secrets (ENV required)"
	@echo "  remove-secrets         Remove GitHub secrets (ENV required)"
	@echo ""
	@echo "ğŸ§¹ MAINTENANCE"
	@echo "  clean                  Clean Terraform cache (ENV required)"
	@echo ""

init:
	@echo ""
	@echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
	@echo "| Initializing - $(WORKSPACE) Environment |"
	@echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
	@echo ""
	@if [ ! -f "$(TFVARS_FILE)" ]; then \
		echo "âŒ $(TFVARS_FILE) not found"; \
		exit 1; \
	fi
	@if [ ! -f "$(BACKEND_CONFIG)" ]; then \
		echo "âŒ $(BACKEND_CONFIG) not found"; \
		exit 1; \
	fi
	@mkdir -p workspaces/$(WORKSPACE)
	@terraform init -reconfigure -backend-config=$(BACKEND_CONFIG)
	@echo ""
	@echo "âœ… Initialized $(WORKSPACE)"
	@echo ""

validate:
	@echo ""
	@echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
	@echo "| Validating - $(WORKSPACE) Environment   |"
	@echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
	@echo ""
	@terraform init -reconfigure -backend-config=$(BACKEND_CONFIG) > /dev/null 2>&1
	@terraform validate
	@echo ""
	@echo "âœ… Configuration valid for $(WORKSPACE)"
	@echo ""

plan:
	@echo ""
	@echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
	@echo "| Planning - $(WORKSPACE) Environment  |"
	@echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
	@echo ""
	@terraform init -reconfigure -backend-config=$(BACKEND_CONFIG) > /dev/null 2>&1
	@terraform plan -var-file=$(TFVARS_FILE)
	@echo ""

apply:
	@echo ""
	@echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
	@echo "| Applying - $(WORKSPACE) Environment  |"
	@echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
	@echo ""
	@terraform init -reconfigure -backend-config=$(BACKEND_CONFIG) > /dev/null 2>&1
	@terraform apply -var-file=$(TFVARS_FILE) -auto-approve
	@echo ""
	@$(MAKE) sync-outputs
	@echo ""
	@echo "âœ… Infrastructure deployed for $(WORKSPACE)"
	@echo ""

destroy:
	@echo ""
	@echo "âš ï¸  WARNING: Destroying $(WORKSPACE) environment"
	@echo ""
	@terraform init -reconfigure -backend-config=$(BACKEND_CONFIG) > /dev/null 2>&1
	@terraform destroy -var-file=$(TFVARS_FILE) -auto-approve
	@echo "âœ… $(WORKSPACE) destroyed"
	@echo ""

output:
	@echo ""
	@echo "ğŸ“¤ Outputs for $(WORKSPACE):"
	@echo ""
	@terraform init -reconfigure -backend-config=$(BACKEND_CONFIG) > /dev/null 2>&1
	@terraform output
	@echo ""

state:
	@echo ""
	@echo "ğŸ“‹ State for $(WORKSPACE):"
	@echo ""
	@terraform init -reconfigure -backend-config=$(BACKEND_CONFIG) > /dev/null 2>&1
	@terraform state list || echo "âš ï¸  No state found"
	@echo ""

update-secrets:
	@echo ""
	@echo "ğŸ” Updating GitHub secrets for $(WORKSPACE)..."
	@bash ../scripts/setup_nifi_github_secrets.sh $(WORKSPACE) --from-env --with-terraform
	@echo ""

remove-secrets:
	@echo ""
	@echo "ğŸ—‘ï¸  Removing GitHub secrets for $(WORKSPACE)..."
	@bash ../scripts/remove_github_secrets.sh $(WORKSPACE) --remove
	@echo ""

clean:
	@echo "ğŸ§¹ Cleaning $(WORKSPACE)..."
	@rm -rf .terraform .terraform.lock.hcl *.tfplan
	@rm -rf workspaces/*/terraform.tfstate*
	@echo "âœ… Cleaned"
	@echo ""