# ========================================================================
# TERRAFORM MAKEFILE: Azure VM Infrastructure with Proper State Isolation
# ========================================================================
# Location: azure-vm-terraform/Makefile

MAKEFLAGS += --no-print-directory

# Environment mapping
ENV ?= development
ENV_MAP_dev := development
ENV_MAP_development := development
ENV_MAP_staging := staging
ENV_MAP_prod := production
ENV_MAP_production := production

WORKSPACE := $(or $(ENV_MAP_$(ENV)),$(ENV))

# Valid workspaces
VALID_WORKSPACES := development staging production

# Paths
TFVARS_FILE := $(WORKSPACE).tfvars
BACKEND_CONFIG := backend-configs/$(WORKSPACE).tfbackend
ROOT_DIR := $(shell pwd)/..
ENV_FILE := $(ROOT_DIR)/.env.$(WORKSPACE)

.DEFAULT_GOAL := help

.PHONY: help init validate plan apply destroy output state \
        init-all validate-all plan-all apply-all destroy-all output-all state-all \
        update-secrets update-secrets-all check-secrets \
        clean clean-all diagnose

help:
	@echo ""
	@echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
	@echo "|  Terraform Infrastructure Manager (State Isolated) |"
	@echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
	@echo ""
	@echo "Usage: make [target] ENV=<environment>"
	@echo ""
	@echo "ğŸ“¦ SINGLE ENVIRONMENT OPERATIONS"
	@echo "  init              Initialize Terraform for environment"
	@echo "  validate          Validate Terraform configuration"
	@echo "  plan              Show execution plan"
	@echo "  apply             Apply infrastructure changes"
	@echo "  destroy           Destroy infrastructure"
	@echo "  output            Show outputs"
	@echo "  state             Show state list"
	@echo ""
	@echo "ğŸ”„ ALL ENVIRONMENTS OPERATIONS"
	@echo "  init-all          Initialize all environments"
	@echo "  validate-all      Validate all configurations"
	@echo "  plan-all          Plan all environments"
	@echo "  apply-all         Deploy all environments (isolated)"
	@echo "  destroy-all       Destroy all environments"
	@echo "  output-all        Show all outputs"
	@echo "  state-all         Show all states"
	@echo ""
	@echo "ğŸ” SECRETS MANAGEMENT"
	@echo "  update-secrets         Update GitHub secrets (ENV required)"
	@echo "  update-secrets-all     Update all GitHub secrets"
	@echo "  check-secrets          Check GitHub secrets status"
	@echo ""
	@echo "ğŸ§¹ MAINTENANCE"
	@echo "  clean                  Clean Terraform cache (ENV required)"
	@echo "  clean-all              Clean all caches"
	@echo "  diagnose               Run diagnostics"
	@echo ""
	@echo "ğŸŒ Valid Environments: development, staging, production"
	@echo ""
	@echo "ğŸ’¡ Example Usage:"
	@echo "  make init ENV=development     # Initialize development"
	@echo "  make apply ENV=staging        # Deploy staging"
	@echo "  make apply-all                # Deploy all (isolated)"
	@echo ""

# =============================================================================
#  INITIALIZATION
# =============================================================================
init:
	@echo ""
	@echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	@echo "  Initializing - $(WORKSPACE) Environment "
	@echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	@echo ""
	@if [ ! -f "$(TFVARS_FILE)" ]; then \
		echo "âŒ $(TFVARS_FILE) not found"; \
		exit 1; \
	fi
	@if [ ! -f "$(BACKEND_CONFIG)" ]; then \
		echo "âŒ $(BACKEND_CONFIG) not found"; \
		exit 1; \
	fi
	@mkdir -p workspaces/$(WORKSPACE)
	@terraform init -reconfigure -backend-config=$(BACKEND_CONFIG)
	@echo ""
	@echo "âœ… Initialized $(WORKSPACE)"
	@echo ""

init-all:
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘ Initializing All Environments  â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@for env in $(VALID_WORKSPACES); do \
		echo "ğŸ”„ Initializing $$env..."; \
		$(MAKE) init ENV=$$env || exit 1; \
	done
	@echo "âœ… All environments initialized!"
	@echo ""

# =============================================================================
#  VALIDATION
# =============================================================================
validate:
	@echo ""
	@echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	@echo "  Validating - $(WORKSPACE) Environment"
	@echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	@echo ""
	@terraform init -reconfigure -backend-config=$(BACKEND_CONFIG) > /dev/null 2>&1
	@terraform validate
	@echo ""
	@echo "âœ… Configuration valid for $(WORKSPACE)"
	@echo ""

validate-all:
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘ Validating All Environments  â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@ERRORS=0; \
	for env in $(VALID_WORKSPACES); do \
		echo "Validating $$env..."; \
		if $(MAKE) validate ENV=$$env; then \
			echo "âœ… $$env valid"; \
		else \
			echo "âŒ $$env validation failed"; \
			ERRORS=$$((ERRORS + 1)); \
		fi; \
		echo ""; \
	done; \
	if [ $$ERRORS -gt 0 ]; then \
		echo "âŒ Validation failed for $$ERRORS environment(s)"; \
		exit 1; \
	fi
	@echo "âœ… All environments validated"
	@echo ""

# =============================================================================
#  PLANNING
# =============================================================================
plan:
	@echo ""
	@echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	@echo "  Planning - $(WORKSPACE) Environment"
	@echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	@echo ""
	@terraform init -reconfigure -backend-config=$(BACKEND_CONFIG) > /dev/null 2>&1
	@terraform plan -var-file=$(TFVARS_FILE)
	@echo ""

plan-all:
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘ Planning All Environments â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@for env in $(VALID_WORKSPACES); do \
		$(MAKE) plan ENV=$$env; \
		sleep 2; \
	done
	@echo "âœ… All plans generated"
	@echo ""

# =============================================================================
#  APPLY
# =============================================================================
apply:
	@echo ""
	@echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	@echo " Applying - $(WORKSPACE) Environment   "
	@echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	@echo ""
	@terraform init -reconfigure -backend-config=$(BACKEND_CONFIG) > /dev/null 2>&1
	@terraform apply -var-file=$(TFVARS_FILE)
	@echo ""
	@$(MAKE) sync-outputs
	@echo ""
	@echo "âœ… Infrastructure deployed for $(WORKSPACE)"
	@echo ""

apply-all:
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘     ğŸš€ Deploying ALL Environments (Isolated)       â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "Each environment has its own state file:"
	@echo "  â€¢ workspaces/development/terraform.tfstate"
	@echo "  â€¢ workspaces/staging/terraform.tfstate"
	@echo "  â€¢ workspaces/production/terraform.tfstate"
	@echo ""
	@read -p "Continue? [y/N]: " confirm; \
	if [ "$$confirm" != "y" ] && [ "$$confirm" != "Y" ]; then \
		echo "âŒ Cancelled"; \
		exit 1; \
	fi
	@FAILED_ENVS=""; \
	APPLIED_COUNT=0; \
	for env in $(VALID_WORKSPACES); do \
		echo ""; \
		echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"; \
		echo "  Applying $$env...     "; \
		echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"; \
		if $(MAKE) apply ENV=$$env; then \
			echo "âœ… $$env deployed successfully"; \
			APPLIED_COUNT=$$((APPLIED_COUNT + 1)); \
		else \
			FAILED_ENVS="$$FAILED_ENVS $$env"; \
			echo "âŒ $$env deployment failed"; \
		fi; \
		if [ "$$env" != "production" ]; then \
			echo "â³ Waiting 30 seconds..."; \
			sleep 30; \
		fi; \
	done; \
	echo ""; \
	echo "ğŸ“Š Deployment Summary: $$APPLIED_COUNT/3 successful"; \
	if [ -n "$$FAILED_ENVS" ]; then \
		echo "âŒ Failed:$$FAILED_ENVS"; \
		exit 1; \
	else \
		echo "ğŸ‰ All environments deployed!"; \
	fi
	@echo ""

# =============================================================================
#  DESTROY
# =============================================================================
destroy:
	@echo ""
	@echo "âš ï¸  WARNING: Destroying $(WORKSPACE) environment"
	@echo ""
	@terraform init -reconfigure -backend-config=$(BACKEND_CONFIG) > /dev/null 2>&1
	@terraform destroy -var-file=$(TFVARS_FILE) -auto-approve
	@echo "âœ… $(WORKSPACE) destroyed"
	@echo ""

destroy-all:
	@echo ""
	@echo "âš ï¸  WARNING: This will destroy ALL environments"
	@echo ""
	@read -p "Type 'destroy-all-environments' to confirm: " confirm; \
	if [ "$$confirm" = "destroy-all-environments" ]; then \
		for env in production staging development; do \
			echo ""; \
			echo "âš ï¸ Destroying $$env..."; \
			$(MAKE) destroy ENV=$$env; \
		done; \
		echo "âœ… All destroyed"; \
	else \
		echo "âŒ Cancelled"; \
	fi
	@echo ""

# =============================================================================
#  OUTPUT & STATE
# =============================================================================
output:
	@echo ""
	@echo "ğŸ“¤ Outputs for $(WORKSPACE):"
	@echo ""
	@terraform init -reconfigure -backend-config=$(BACKEND_CONFIG) > /dev/null 2>&1
	@terraform output
	@echo ""

output-all:
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘ Outputs - All Environments â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@for env in $(VALID_WORKSPACES); do \
		echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"; \
		echo " $$env Environment         "; \
		echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"; \
		$(MAKE) output ENV=$$env; \
	done

state:
	@echo ""
	@echo "ğŸ“‹ State for $(WORKSPACE):"
	@echo ""
	@terraform init -reconfigure -backend-config=$(BACKEND_CONFIG) > /dev/null 2>&1
	@terraform state list || echo "âš ï¸  No state found"
	@echo ""

state-all:
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘ State - All Environments  â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@for env in $(VALID_WORKSPACES); do \
		echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"; \
		echo " $$env Environment         "; \
		echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"; \
		$(MAKE) state ENV=$$env; \
	done

# =============================================================================
#  OUTPUT SYNCHRONIZATION
# =============================================================================
sync-outputs:
	@echo "ğŸ”„ Syncing outputs to $(ENV_FILE)..."
	@if [ ! -f "$(ENV_FILE)" ]; then \
		echo "âš ï¸  $(ENV_FILE) not found - skipping"; \
		exit 0; \
	fi
	@VM_IP=$$(terraform output -raw vm_public_ip 2>/dev/null || echo ""); \
	if [ -n "$$VM_IP" ] && [ "$$VM_IP" != "" ]; then \
		sed -i.bak "s|^VM_PUBLIC_IP=.*|VM_PUBLIC_IP=$$VM_IP|" "$(ENV_FILE)" 2>/dev/null || \
		sed -i '' "s|^VM_PUBLIC_IP=.*|VM_PUBLIC_IP=$$VM_IP|" "$(ENV_FILE)" 2>/dev/null; \
		echo "  âœ… VM_PUBLIC_IP updated: $$VM_IP"; \
		rm -f "$(ENV_FILE).bak"; \
	fi

# =============================================================================
#  GITHUB SECRETS
# =============================================================================
update-secrets:
	@echo ""
	@echo "ğŸ” Updating GitHub secrets for $(WORKSPACE)..."
	@bash ../scripts/setup_nifi_github_secrets.sh $(WORKSPACE) --from-env --with-terraform
	@echo ""

update-secrets-all:
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘ Updating GitHub Secrets - All Envs â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@bash ../scripts/setup_nifi_github_secrets.sh all --from-env --with-terraform
	@echo ""

check-secrets:
	@echo ""
	@echo "ğŸ“‹ GitHub Secrets Status:"
	@echo ""
	@for env in $(VALID_WORKSPACES); do \
		echo "$$env:"; \
		gh secret list --env $$env 2>/dev/null || echo "  No secrets"; \
		echo ""; \
	done

remove-secrets:
	@echo ""
	@echo "ğŸ—‘ï¸  Removing GitHub secrets for $(WORKSPACE)..."
	@bash ../scripts/remove_github_secrets.sh $(WORKSPACE) --remove
	@echo ""

remove-secrets-all:
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘ Removing GitHub Secrets - All Envs  â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@bash ../scripts/remove_github_secrets.sh all --remove
	@echo ""
# =============================================================================
#  CLEANUP
# =============================================================================
clean:
	@echo "ğŸ§¹ Cleaning $(WORKSPACE)..."
	@rm -rf .terraform .terraform.lock.hcl *.tfplan
	@rm -rf workspaces/*/terraform.tfstate*
	@echo "âœ… Cleaned"
	@echo ""

clean-all:
	@echo "ğŸ§¹ Cleaning all..."
	@rm -rf .terraform .terraform.lock.hcl *.tfplan
	@rm -rf workspaces/*/terraform.tfstate*
	@echo "âœ… All cleaned"
	@echo ""

# =============================================================================
#  DIAGNOSTICS
# =============================================================================
diagnose:
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘ Terraform Diagnostics â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@for env in $(VALID_WORKSPACES); do \
		echo "Environment: $$env"; \
		echo "  Backend: backend-configs/$$env.tfbackend"; \
		if [ -f "backend-configs/$$env.tfbackend" ]; then \
			echo "  âœ… Backend config exists"; \
			cat "backend-configs/$$env.tfbackend" | sed 's/^/    /'; \
		fi; \
		echo "  State: workspaces/$$env/terraform.tfstate"; \
		if [ -f "workspaces/$$env/terraform.tfstate" ]; then \
			RESOURCES=$$(grep -c '"type":' "workspaces/$$env/terraform.tfstate" 2>/dev/null || echo "0"); \
			echo "  âœ… State exists ($$RESOURCES resources)"; \
		else \
			echo "  âš ï¸  No state file"; \
		fi; \
		echo ""; \
	done
	@echo "âœ… Diagnostic complete"
	@echo ""